<!DOCTYPE html>
<html>
<title>&nbsp;</title>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="http://code.jquery.com/mobile/1.3.2/jquery.mobile-1.3.2.min.css" />	
	<script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>	
	<script src="http://code.jquery.com/mobile/1.3.2/jquery.mobile-1.3.2.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?sensor=false&v=3&libraries=geometry"></script>
	<script type="text/javascript" charset="utf-8" src="cordova.js"></script>
		
	<style>
		#content {
		padding: 0;
		position : absolute !important;
		top : 40px !important;  
		right : 0; 
		bottom : 0px !important;  
		left : 0 !important;     
		}		
	</style>

	
    <script>
		var cnt = 0;
		var sampling = 0;
		var markers = [];
		var map, lastmarker;
		var lastplot = null;
		//var lastwatch = null;
		var mypos = null;
		var mycircle = null;
		var myadr = '';
		var image = new google.maps.MarkerImage(
				'bluedot.png',
				null, // size
				null, // origin
				new google.maps.Point( 8, 8 ), // anchor (move to center of marker)
				new google.maps.Size( 17, 17 ) // scaled size (required for Retina display icon)
				);
    
	
		// Create location
		function pt2location(lat, lng) {
			var loc = new google.maps.LatLng(lat, lng);
			return(loc);
			}

		// car	
		var car = "M17.402,0H5.643C2.526,0,0,3.467,0,6.584v34.804c0,3.116,2.526,5.644,5.643,5.644h11.759c3.116,0,5.644-2.527,5.644-5.644 V6.584C23.044,3.467,20.518,0,17.402,0z M22.057,14.188v11.665l-2.729,0.351v-4.806L22.057,14.188z M20.625,10.773 c-1.016,3.9-2.219,8.51-2.219,8.51H4.638l-2.222-8.51C2.417,10.773,11.3,7.755,20.625,10.773z M3.748,21.713v4.492l-2.73-0.349 V14.502L3.748,21.713z M1.018,37.938V27.579l2.73,0.343v8.196L1.018,37.938z M2.575,40.882l2.218-3.336h13.771l2.219,3.336H2.575z M19.328,35.805v-7.872l2.729-0.355v10.048L19.328,35.805z";
		var caricon = {
			path: car,
			scale: .7,
			strokeColor: 'white',
			strokeWeight: .10,
			fillOpacity: 1,
			fillColor: '#404040',
			offset: '5%',
			// rotation: heading,  					// var heading = google.maps.geometry.spherical.computeHeading(lastPosn, p);
			anchor: new google.maps.Point(10, 25)	// orig 10,50 back of car, 10,0 front of car, 10,25 center of car
			};
			
		// place marker
		function createmarker(location) {
			var marker = new google.maps.Marker({
				position: location,
				map: map,
				});
			lastplot = location;	
			}	
				
		function createcircle(location, rad) {
			mycircle = new google.maps.Circle({
				center:location,
				radius:rad,
				strokeColor:"#0000FF",
				strokeOpacity:0.8,
				strokeWeight:2,
				fillColor:"#0000FF",
				fillOpacity:0.1,
				map: map
				});
			//mycircle.setmap(map);	 mangler uppercase
			}		
			
		function creategreenmarker(location) {
			mypos = new google.maps.Marker({
				position: location,
				flat: true,
				icon: caricon,				
				//icon: image,
				title: 'I might be here',				
				//icon: 'http://maps.google.com/mapfiles/ms/icons/green-dot.png', 
				map: map,
				});
			}
			
		function createOrRelocate(location, rad) {
			if (mypos == null) {
				creategreenmarker(location);
				createcircle(location, rad);
				}
			else {
				mypos.setPosition(location);

				var heading = 0;
				if(location) { heading = location.getBearing();	}	// 0 to 360 degrees
				mypos.icon.rotation = heading;
				
				mycircle.setCenter(location);
				mycircle.setRadius(rad);
				}
			//if (mycircle != null) { alert('circle ');	} else { alert('circle null'); } 
			}	

		//--------------------------------------------------------------
		
		function initialize() {
			var mapOptions = {
				zoom: 12,
				center: new google.maps.LatLng(59.5, 10.5),
				mapTypeId: google.maps.MapTypeId.ROADMAP
				};
			map = new google.maps.Map(document.getElementById('map_canvas'), mapOptions);    
			} // initialize

		google.maps.event.addDomListener(window, 'load', initialize);
      
	</script>

	<script>
		var geocoder = new google.maps.Geocoder();

		function geocodePosition(pos) {
			geocoder.geocode({
				latLng: pos
			}, function(responses) {
				if (responses && responses.length > 0) {
					updateMarkerAddress(responses[0].formatted_address);
				} else {
					updateMarkerAddress('Cannot determine address at this location.');
				}
			});
		}
		
		function updateMarkerAddress(str) {
			//document.getElementById('address').innerHTML = str;
			myadr = str;
			$('#result').text(str);
		}
	</script>
	
	<script>
		$(document).ready(function(){
			$("#siste").click(function(){
				alert('siste');
				$( "#myPanel-r" ).panel( "close" );
			});
			$("#alle").click(function(){
				alert('alle');
				$( "#myPanel-r" ).panel( "close" );
			});
			$("#linje").click(function(){
				alert('linje');
				$( "#myPanel-r" ).panel( "close" );
			});
			$("#start").click(function(){
				if (!watchID) { startWatching(); }
				//alert('start');
				$('#result').text('tracking started!');
			});
			$("#stop").click(function(){
				if (watchID) { stopWatching(); }
				//alert('stop');
				$('#result').text('tracking stopped!');
			});
		});
	</script>

	<script>
		var watchID = null;		
		startWatching();
		
		
		// onSuccess Callback
		function onSuccess(position) {
			var loc = pt2location(position.coords.latitude, position.coords.longitude);
			
			
			// mypos			
			createOrRelocate(loc, position.coords.accuracy);
			map.panTo(loc);
			
			// adr on footer
			geocodePosition(loc);

			
			if (sampling > 1) { 
				sampling = 0; 
				
				if (lastplot != null) {
					var dist = google.maps.geometry.spherical.computeDistanceBetween (lastplot, loc);
					}
				else { 
					var dist = -1;
					}	
					
				if (dist < 0) { /*alert('under 0');*/ plotmarker(position,loc,dist); }
				if (dist > 50) { /*alert('over 50');*/ plotmarker(position,loc,dist); }
				//if (dist > 0 && dist < 50) { alert('i midten'); }
				//if (dist < 0 || dist > 50) { alert('under 0 - eller over 50'); }
				}					
		}

		function plotmarker(position,loc,dist) {
			var element = document.getElementById('geolocation');
			
			createmarker(loc);
			var d = new Date();
			var t = d.toLocaleTimeString();
				
			// adr on #page2
			element.innerHTML = '<strong>#' + cnt + '</strong> - ' 
								+ position.coords.latitude + ', ' 
								+ position.coords.longitude + ', ' 
								+ position.coords.accuracy + '<br />' 
								+ '<strong>' + myadr + '</strong> <br />'
								+ t + '<br />' 
								+ dist + '<br />' 
								+ '<hr />' + element.innerHTML;																				
			cnt = cnt + 1;				
		}
		
		// onError Callback receives a PositionError object
		function onError(error) {
			alert('code: '    + error.code    + '\n' +
				  'message: ' + error.message + '\n');
		}
		
		function startWatching() {
			watchID = navigator.geolocation.watchPosition(onSuccess, onError, { timeout: 30000 });
		}
		
		function stopWatching() {
			navigator.geolocation.clearWatch(watchID);
		}
				
	</script>

	<script>
		function onInterval() {
			
			//alert('Interval - Every 10 secs '+sampling);
			sampling = sampling+1;
		};
		
		$(document).ready(function(){
			window.setInterval(function() {
				onInterval();
			},5000);	
		});
	</script>
	
	
</head>
	
<body>
	<div data-role="page" id="page1">
		<div data-role="panel" id="myPanel-r" data-display="overlay" data-position="right" data-theme="c">
			<ul data-role="listview" data-theme="d" data-icon="false">
				<li id="hdr" data-icon="delete" data-theme="b"><a href="#" data-rel="close">Tracking</a></li>
				<li id="siste" data-icon="check" class="ui-icon-alt" ><a href="#">Siste posisjon</a></li>
				<li id="alle" data-icon="" class="ui-icon-alt"><a href="#" >Alle posisjoner</a></li>
				<li id="linje" data-icon="home" class="ui-icon-alt"><a href="#" >Linje</a></li>
				<li id="tabell" data-icon="" class="ui-icon-alt"><a href="#page2" >Tabell</a></li>
				<li id="start" data-icon="" ><a href="" >Start tracking</a></li>
				<li id="stop" data-icon="" ><a href="" >Stopp tracking</a></li>
			</ul>
		</div><!-- /panel -->
				
		
		<div data-theme="a" data-role="header">
			<a data-rel="back" data-ajax="false" data-icon="arrow-l">Tilbake</a>
			<h3>Page Header</h3>
			<a href="#myPanel-r" class="jqm-navmenu-link" data-icon="bars" data-iconpos="notext">Navigation</a>
		</div>
		
		<div data-role="content" id="content">
			<div id="map_canvas" style="height:100%"></div>
		</div>
		
		<div data-theme="a" data-role="footer" data-position="fixed">
			<div id="result">Tracking..</div>
		</div>
	</div>

	
	<div data-role="page" id="page2">
		<div data-theme="a" data-role="header">
			<a data-rel="back" data-ajax="false" data-icon="arrow-l">Tilbake</a>
			<h3>Page Header</h3>
		</div>
		
		<div data-role="content" id="content2">
			<div id="geolocation"></div>
		</div>
		
		<div data-theme="a" data-role="footer" data-position="fixed">
			<h3>Page Footer</h3>
		</div>
	</div>	
	
</body>

</html>
